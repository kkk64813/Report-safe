<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¬å‘Šç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ddd;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        h1 {
            color: #2c3e50;
            margin: 0;
        }
        
        .home-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
            text-decoration: none;
            display: inline-block;
        }
        
        .home-btn:hover {
            background: #2980b9;
        }
        
        .notice-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            min-height: 200px;
        }
        
        .notice-content {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 16px;
            line-height: 1.8;
        }
        
        .empty-notice {
            color: #7f8c8d;
            font-style: italic;
            text-align: center;
            padding: 50px 0;
        }
        
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #2980b9;
        }
        
        button.danger {
            background: #e74c3c;
        }
        
        button.danger:hover {
            background: #c0392b;
        }
        
        button.secondary {
            background: #95a5a6;
        }
        
        button.secondary:hover {
            background: #7f8c8d;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal h2 {
            margin-bottom: 20px;
            color: #2c3e50;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #34495e;
        }
        
        input, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        textarea {
            min-height: 150px;
            resize: vertical;
            font-family: inherit;
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .char-count {
            text-align: right;
            color: #7f8c8d;
            font-size: 12px;
            margin-top: 5px;
        }
        
        .error-message {
            color: #e74c3c;
            margin-top: 5px;
            font-size: 14px;
        }
        
        .success-message {
            color: #27ae60;
            margin-top: 5px;
            font-size: 14px;
        }
        
        .admin-controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s;
        }
        
        .admin-controls.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .history-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-top: 30px;
        }
        
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .history-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .history-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .history-content {
            flex: 1;
            margin-right: 20px;
        }
        
        .history-meta {
            color: #7f8c8d;
            font-size: 12px;
            margin-top: 5px;
        }
        
        .history-actions {
            display: flex;
            gap: 10px;
        }
        
        .empty-history {
            text-align: center;
            color: #7f8c8d;
            padding: 40px 0;
            font-style: italic;
        }
        
        .view-history-btn {
            margin-top: 20px;
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .header-left {
                width: 100%;
                justify-content: space-between;
            }
            
            .notice-container {
                padding: 20px;
            }
            
            .form-actions {
                flex-direction: column;
            }
            
            .admin-controls {
                flex-wrap: wrap;
            }
            
            .history-item {
                flex-direction: column;
            }
            
            .history-content {
                margin-right: 0;
                margin-bottom: 10px;
            }
            
            .history-actions {
                align-self: flex-end;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-left">
            <h1>ğŸ“¢ å…¬å‘Šç³»ç»Ÿ</h1>
            <a href="index.html" class="home-btn">è¿”å›é¦–é¡µ</a>
        </div>
        <button id="adminBtn">ç®¡ç†å‘˜ç™»å½•</button>
    </header>
    
    <main>
        <div class="notice-container">
            <div id="noticeContent" class="notice-content">
                æ­£åœ¨åŠ è½½å…¬å‘Š...
            </div>
        </div>
        
        <button id="showHistoryBtn" class="view-history-btn">ğŸ“œ æŸ¥çœ‹å†å²å…¬å‘Š</button>
        
        <div class="admin-controls" id="adminControls">
            <button id="editNoticeBtn">ç¼–è¾‘å…¬å‘Š</button>
            <button id="deleteNoticeBtn" class="danger">åˆ é™¤å…¬å‘Š</button>
            <button id="changePasswordBtn">ä¿®æ”¹å¯†ç </button>
            <button id="logoutBtn">é€€å‡ºç™»å½•</button>
        </div>
        
        <!-- å†å²å…¬å‘ŠåŒºåŸŸ -->
        <div class="history-section" id="historySection" style="display: none;">
            <div class="history-header">
                <h2>ğŸ“œ å†å²å…¬å‘Š</h2>
                <button id="closeHistoryBtn" class="secondary">å…³é—­å†å²</button>
            </div>
            <div class="history-list" id="historyList">
                æ­£åœ¨åŠ è½½å†å²å…¬å‘Š...
            </div>
        </div>
    </main>
    
    <!-- ç™»å½•æ¨¡æ€æ¡† -->
    <div class="modal" id="loginModal">
        <div class="modal-content">
            <h2>ç®¡ç†å‘˜ç™»å½•</h2>
            <div class="form-group">
                <label for="loginPassword">å¯†ç </label>
                <input type="password" id="loginPassword" placeholder="è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ">
                <div class="error-message" id="loginError"></div>
            </div>
            <div class="form-actions">
                <button id="loginBtn" style="flex: 1">ç™»å½•</button>
                <button id="cancelLoginBtn" class="secondary">å–æ¶ˆ</button>
            </div>
            <div class="char-count">
                å¯†ç è§„åˆ™ï¼š6-10ä½ï¼Œä»…é™æ•°å­—å’Œå­—æ¯
            </div>
        </div>
    </div>
    
    <!-- ç¼–è¾‘å…¬å‘Šæ¨¡æ€æ¡† -->
    <div class="modal" id="editNoticeModal">
        <div class="modal-content">
            <h2>ç¼–è¾‘å…¬å‘Š</h2>
            <div class="form-group">
                <label for="noticeText">å…¬å‘Šå†…å®¹ (æœ€å¤š1000å­—)</label>
                <textarea id="noticeText" placeholder="è¯·è¾“å…¥å…¬å‘Šå†…å®¹..."></textarea>
                <div class="char-count">
                    <span id="charCount">0</span>/1000
                </div>
                <div class="error-message" id="editError"></div>
                <div class="success-message" id="editSuccess"></div>
            </div>
            <div class="form-actions">
                <button id="publishBtn" style="flex: 1">å‘å¸ƒå…¬å‘Š</button>
                <button id="cancelEditBtn" class="secondary">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
    
    <!-- ä¿®æ”¹å¯†ç æ¨¡æ€æ¡† -->
    <div class="modal" id="changePasswordModal">
        <div class="modal-content">
            <h2>ä¿®æ”¹å¯†ç </h2>
            <div class="form-group">
                <label for="oldPassword">å½“å‰å¯†ç </label>
                <input type="password" id="oldPassword" placeholder="è¯·è¾“å…¥å½“å‰å¯†ç ">
            </div>
            <div class="form-group">
                <label for="newPassword">æ–°å¯†ç </label>
                <input type="password" id="newPassword" placeholder="6-10ä½æ•°å­—æˆ–å­—æ¯">
                <div class="error-message" id="passwordError"></div>
                <div class="success-message" id="passwordSuccess"></div>
            </div>
            <div class="form-group">
                <label for="confirmPassword">ç¡®è®¤æ–°å¯†ç </label>
                <input type="password" id="confirmPassword" placeholder="è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç ">
            </div>
            <div class="form-actions">
                <button id="savePasswordBtn" style="flex: 1">ä¿å­˜å¯†ç </button>
                <button id="cancelPasswordBtn" class="secondary">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script>
        // é…ç½®
        const API_BASE = 'https://notice-board.mgjack13.workers.dev';
        
        // çŠ¶æ€ç®¡ç†
        let isLoggedIn = false;
        let authToken = null;
        let currentNotice = '';
        
        // DOM å…ƒç´ 
        const adminBtn = document.getElementById('adminBtn');
        const adminControls = document.getElementById('adminControls');
        const noticeContent = document.getElementById('noticeContent');
        const showHistoryBtn = document.getElementById('showHistoryBtn');
        const historySection = document.getElementById('historySection');
        const historyList = document.getElementById('historyList');
        const closeHistoryBtn = document.getElementById('closeHistoryBtn');
        
        // æ¨¡æ€æ¡†
        const loginModal = document.getElementById('loginModal');
        const editNoticeModal = document.getElementById('editNoticeModal');
        const changePasswordModal = document.getElementById('changePasswordModal');
        
        // ç™»å½•ç›¸å…³
        const loginPassword = document.getElementById('loginPassword');
        const loginBtn = document.getElementById('loginBtn');
        const cancelLoginBtn = document.getElementById('cancelLoginBtn');
        const loginError = document.getElementById('loginError');
        
        // ç¼–è¾‘å…¬å‘Šç›¸å…³
        const noticeText = document.getElementById('noticeText');
        const charCount = document.getElementById('charCount');
        const publishBtn = document.getElementById('publishBtn');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const editError = document.getElementById('editError');
        const editSuccess = document.getElementById('editSuccess');
        
        // æ§åˆ¶æŒ‰é’®
        const editNoticeBtn = document.getElementById('editNoticeBtn');
        const deleteNoticeBtn = document.getElementById('deleteNoticeBtn');
        const changePasswordBtn = document.getElementById('changePasswordBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        
        // ä¿®æ”¹å¯†ç ç›¸å…³
        const oldPassword = document.getElementById('oldPassword');
        const newPassword = document.getElementById('newPassword');
        const confirmPassword = document.getElementById('confirmPassword');
        const savePasswordBtn = document.getElementById('savePasswordBtn');
        const cancelPasswordBtn = document.getElementById('cancelPasswordBtn');
        const passwordError = document.getElementById('passwordError');
        const passwordSuccess = document.getElementById('passwordSuccess');
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            loadNotice();
            setupEventListeners();
            
            // æ£€æŸ¥æœ¬åœ°å­˜å‚¨ä¸­æ˜¯å¦æœ‰ç™»å½•çŠ¶æ€
            const savedToken = localStorage.getItem('noticeAdminToken');
            const savedLoginState = localStorage.getItem('noticeIsLoggedIn');
            
            if (savedToken && savedLoginState === 'true') {
                isLoggedIn = true;
                authToken = savedToken;
                showAdminControls();
                adminBtn.textContent = 'ç®¡ç†å‘˜å·²ç™»å½•';
            }
        });
        
        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // ç®¡ç†å‘˜æŒ‰é’®
            adminBtn.addEventListener('click', showLoginModal);
            
            // æŸ¥çœ‹å†å²å…¬å‘ŠæŒ‰é’®
            showHistoryBtn.addEventListener('click', showHistory);
            closeHistoryBtn.addEventListener('click', hideHistory);
            
            // ç™»å½•ç›¸å…³
            loginBtn.addEventListener('click', handleLogin);
            cancelLoginBtn.addEventListener('click', () => hideModal(loginModal));
            loginPassword.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleLogin();
            });
            
            // ç¼–è¾‘å…¬å‘Šç›¸å…³
            editNoticeBtn.addEventListener('click', showEditModal);
            publishBtn.addEventListener('click', publishNotice);
            cancelEditBtn.addEventListener('click', () => hideModal(editNoticeModal));
            noticeText.addEventListener('input', updateCharCount);
            
            // åˆ é™¤å…¬å‘Š
            deleteNoticeBtn.addEventListener('click', deleteNotice);
            
            // ä¿®æ”¹å¯†ç ç›¸å…³
            changePasswordBtn.addEventListener('click', showChangePasswordModal);
            savePasswordBtn.addEventListener('click', changePassword);
            cancelPasswordBtn.addEventListener('click', () => hideModal(changePasswordModal));
            
            // é€€å‡ºç™»å½•
            logoutBtn.addEventListener('click', logout);
        }
        
        // åŠ è½½å…¬å‘Š
        async function loadNotice() {
            try {
                const response = await fetch(`${API_BASE}/api/notice`);
                const data = await response.json();
                
                if (data.success) {
                    currentNotice = data.notice || '';
                    noticeContent.innerHTML = currentNotice 
                        ? currentNotice.replace(/\n/g, '<br>')
                        : '<div class="empty-notice">æš‚æ— å…¬å‘Š</div>';
                }
            } catch (error) {
                console.error('åŠ è½½å…¬å‘Šå¤±è´¥:', error);
                noticeContent.innerHTML = '<div class="empty-notice">åŠ è½½å…¬å‘Šå¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢</div>';
            }
        }
        
        // æ˜¾ç¤ºå†å²å…¬å‘Šï¼ˆæ‰€æœ‰äººéƒ½å¯ä»¥æŸ¥çœ‹ï¼‰
        async function showHistory() {
            try {
                historyList.innerHTML = 'æ­£åœ¨åŠ è½½å†å²å…¬å‘Š...';
                historySection.style.display = 'block';
                
                const response = await fetch(`${API_BASE}/api/notice/history`);
                const data = await response.json();
                
                if (data.success) {
                    const history = data.history || [];
                    
                    if (history.length === 0) {
                        historyList.innerHTML = '<div class="empty-history">æš‚æ— å†å²å…¬å‘Š</div>';
                        return;
                    }
                    
                    let html = '';
                    history.forEach(item => {
                        const date = new Date(item.timestamp);
                        const formattedDate = date.toLocaleString('zh-CN');
                        const shortContent = item.content.length > 100 
                            ? item.content.substring(0, 100) + '...' 
                            : item.content;
                        
                        // åªæœ‰ç®¡ç†å‘˜ç™»å½•æ—¶æ‰æ˜¾ç¤ºåˆ é™¤æŒ‰é’®
                        const deleteButton = isLoggedIn 
                            ? `<button class="danger delete-history-btn" data-id="${item.id}">åˆ é™¤</button>`
                            : '';
                        
                        html += `
                            <div class="history-item">
                                <div class="history-content">
                                    <div>${shortContent.replace(/\n/g, '<br>')}</div>
                                    <div class="history-meta">å‘å¸ƒäºï¼š${formattedDate}</div>
                                </div>
                                <div class="history-actions">
                                    ${deleteButton}
                                </div>
                            </div>
                        `;
                    });
                    
                    historyList.innerHTML = html;
                    
                    // ä¸ºåˆ é™¤æŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                    document.querySelectorAll('.delete-history-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const id = e.target.getAttribute('data-id');
                            deleteHistoryNotice(id);
                        });
                    });
                } else {
                    historyList.innerHTML = '<div class="empty-history">åŠ è½½å†å²å…¬å‘Šå¤±è´¥</div>';
                }
            } catch (error) {
                console.error('åŠ è½½å†å²å…¬å‘Šå¤±è´¥:', error);
                historyList.innerHTML = '<div class="empty-history">åŠ è½½å†å²å…¬å‘Šå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</div>';
            }
            
            // æ»šåŠ¨åˆ°å†å²åŒºåŸŸ
            historySection.scrollIntoView({ behavior: 'smooth' });
        }
        
        // éšè—å†å²å…¬å‘Š
        function hideHistory() {
            historySection.style.display = 'none';
        }
        
        // æ˜¾ç¤ºç™»å½•æ¨¡æ€æ¡†
        function showLoginModal() {
            if (isLoggedIn) {
                if (confirm('æ‚¨å·²ç™»å½•ï¼Œæ˜¯å¦è¦é€€å‡ºï¼Ÿ')) {
                    logout();
                }
                return;
            }
            
            loginPassword.value = '';
            loginError.textContent = '';
            showModal(loginModal);
        }
        
        // å¤„ç†ç™»å½•
        async function handleLogin() {
            const password = loginPassword.value.trim();
            
            // å‰ç«¯æ ¼å¼éªŒè¯
            if (!password) {
                loginError.textContent = 'è¯·è¾“å…¥å¯†ç ';
                return;
            }
            
            if (!/^[A-Za-z0-9]{6,10}$/.test(password)) {
                loginError.textContent = 'å¯†ç å¿…é¡»æ˜¯6-10ä½çš„å­—æ¯æˆ–æ•°å­—';
                return;
            }
            
            loginError.textContent = '';
            loginBtn.textContent = 'ç™»å½•ä¸­...';
            loginBtn.disabled = true;
            
            try {
                const response = await fetch(`${API_BASE}/api/admin/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    isLoggedIn = true;
                    authToken = data.token;
                    
                    // ä¿å­˜ç™»å½•çŠ¶æ€åˆ°æœ¬åœ°å­˜å‚¨
                    localStorage.setItem('noticeAdminToken', authToken);
                    localStorage.setItem('noticeIsLoggedIn', 'true');
                    
                    hideModal(loginModal);
                    showAdminControls();
                    showMessage('ç™»å½•æˆåŠŸ', 'success');
                    
                    // åˆ·æ–°å†å²å…¬å‘Šåˆ—è¡¨ä»¥æ˜¾ç¤ºåˆ é™¤æŒ‰é’®
                    if (historySection.style.display === 'block') {
                        showHistory();
                    }
                } else {
                    loginError.textContent = data.error || 'ç™»å½•å¤±è´¥';
                }
            } catch (error) {
                console.error('ç™»å½•å¤±è´¥:', error);
                loginError.textContent = 'ç™»å½•å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
            } finally {
                loginBtn.textContent = 'ç™»å½•';
                loginBtn.disabled = false;
            }
        }
        
        // åˆ é™¤å†å²å…¬å‘Šï¼ˆä»…ç®¡ç†å‘˜ï¼‰
        async function deleteHistoryNotice(id) {
            if (!id || !isLoggedIn) {
                showMessage('è¯·å…ˆç™»å½•ç®¡ç†å‘˜è´¦æˆ·', 'error');
                return;
            }
            
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å†å²å…¬å‘Šå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/admin/notice/history`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ id })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage('å†å²å…¬å‘Šå·²åˆ é™¤', 'success');
                    // é‡æ–°åŠ è½½å†å²åˆ—è¡¨
                    showHistory();
                } else {
                    showMessage(data.error || 'åˆ é™¤å¤±è´¥', 'error');
                    if (data.error === 'Unauthorized') {
                        logout();
                    }
                }
            } catch (error) {
                console.error('åˆ é™¤å†å²å…¬å‘Šå¤±è´¥:', error);
                showMessage('åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
            }
        }
        
        // æ˜¾ç¤ºç¼–è¾‘æ¨¡æ€æ¡†
        function showEditModal() {
            if (!isLoggedIn) {
                showLoginModal();
                return;
            }
            
            noticeText.value = currentNotice;
            editError.textContent = '';
            editSuccess.textContent = '';
            updateCharCount();
            showModal(editNoticeModal);
        }
        
        // æ›´æ–°å­—ç¬¦è®¡æ•°
        function updateCharCount() {
            const count = noticeText.value.length;
            charCount.textContent = count;
            charCount.style.color = count > 1000 ? '#e74c3c' : '#7f8c8d';
        }
        
        // å‘å¸ƒå…¬å‘Š
        async function publishNotice() {
            const content = noticeText.value.trim();
            
            if (content.length > 1000) {
                editError.textContent = 'å…¬å‘Šå†…å®¹ä¸èƒ½è¶…è¿‡1000å­—';
                return;
            }
            
            if (!content) {
                editError.textContent = 'å…¬å‘Šå†…å®¹ä¸èƒ½ä¸ºç©º';
                return;
            }
            
            editError.textContent = '';
            editSuccess.textContent = '';
            publishBtn.textContent = 'å‘å¸ƒä¸­...';
            publishBtn.disabled = true;
            
            try {
                const response = await fetch(`${API_BASE}/api/admin/notice`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        action: 'publish',
                        content
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    editSuccess.textContent = data.message;
                    currentNotice = content;
                    setTimeout(() => {
                        hideModal(editNoticeModal);
                        loadNotice();
                        showMessage('å…¬å‘Šå‘å¸ƒæˆåŠŸ', 'success');
                    }, 1500);
                } else {
                    editError.textContent = data.error || 'å‘å¸ƒå¤±è´¥';
                    if (data.error === 'Unauthorized') {
                        logout();
                    }
                }
            } catch (error) {
                console.error('å‘å¸ƒå¤±è´¥:', error);
                editError.textContent = 'å‘å¸ƒå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
            } finally {
                publishBtn.textContent = 'å‘å¸ƒå…¬å‘Š';
                publishBtn.disabled = false;
            }
        }
        
        // åˆ é™¤å½“å‰å…¬å‘Š
        async function deleteNotice() {
            if (!isLoggedIn) {
                showLoginModal();
                return;
            }
            
            if (!confirm('ç¡®å®šè¦åˆ é™¤å½“å‰å…¬å‘Šå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼Œå½“å‰å…¬å‘Šå°†ä¿å­˜åˆ°å†å²è®°å½•ä¸­ã€‚')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/admin/notice`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ action: 'delete' })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentNotice = '';
                    loadNotice();
                    showMessage('å…¬å‘Šå·²åˆ é™¤å¹¶ä¿å­˜åˆ°å†å²è®°å½•', 'success');
                } else {
                    showMessage(data.error || 'åˆ é™¤å¤±è´¥', 'error');
                    if (data.error === 'Unauthorized') {
                        logout();
                    }
                }
            } catch (error) {
                console.error('åˆ é™¤å¤±è´¥:', error);
                showMessage('åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
            }
        }
        
        // æ˜¾ç¤ºä¿®æ”¹å¯†ç æ¨¡æ€æ¡†
        function showChangePasswordModal() {
            if (!isLoggedIn) {
                showLoginModal();
                return;
            }
            
            oldPassword.value = '';
            newPassword.value = '';
            confirmPassword.value = '';
            passwordError.textContent = '';
            passwordSuccess.textContent = '';
            showModal(changePasswordModal);
        }
        
        // ä¿®æ”¹å¯†ç 
        async function changePassword() {
            const oldPass = oldPassword.value.trim();
            const newPass = newPassword.value.trim();
            const confirmPass = confirmPassword.value.trim();
            
            // å‰ç«¯éªŒè¯
            if (!oldPass || !newPass || !confirmPass) {
                passwordError.textContent = 'è¯·å¡«å†™æ‰€æœ‰å¯†ç å­—æ®µ';
                return;
            }
            
            if (newPass !== confirmPass) {
                passwordError.textContent = 'ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´';
                return;
            }
            
            if (!/^[A-Za-z0-9]{6,10}$/.test(newPass)) {
                passwordError.textContent = 'æ–°å¯†ç å¿…é¡»æ˜¯6-10ä½çš„å­—æ¯æˆ–æ•°å­—';
                return;
            }
            
            passwordError.textContent = '';
            savePasswordBtn.textContent = 'ä¿å­˜ä¸­...';
            savePasswordBtn.disabled = true;
            
            try {
                const response = await fetch(`${API_BASE}/api/admin/change-password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        oldPassword: oldPass,
                        newPassword: newPass
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    passwordSuccess.textContent = data.message;
                    setTimeout(() => {
                        hideModal(changePasswordModal);
                        logout();
                        showMessage('å¯†ç ä¿®æ”¹æˆåŠŸï¼Œè¯·é‡æ–°ç™»å½•', 'success');
                    }, 1500);
                } else {
                    passwordError.textContent = data.error || 'ä¿®æ”¹å¤±è´¥';
                    if (data.error === 'Unauthorized') {
                        logout();
                    }
                }
            } catch (error) {
                console.error('ä¿®æ”¹å¯†ç å¤±è´¥:', error);
                passwordError.textContent = 'ä¿®æ”¹å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
            } finally {
                savePasswordBtn.textContent = 'ä¿å­˜å¯†ç ';
                savePasswordBtn.disabled = false;
            }
        }
        
        // é€€å‡ºç™»å½•
        function logout() {
            isLoggedIn = false;
            authToken = null;
            
            // æ¸…é™¤æœ¬åœ°å­˜å‚¨
            localStorage.removeItem('noticeAdminToken');
            localStorage.removeItem('noticeIsLoggedIn');
            
            hideAdminControls();
            adminBtn.textContent = 'ç®¡ç†å‘˜ç™»å½•';
            showMessage('å·²é€€å‡ºç™»å½•', 'info');
            
            // åˆ·æ–°å†å²å…¬å‘Šåˆ—è¡¨ä»¥éšè—åˆ é™¤æŒ‰é’®
            if (historySection.style.display === 'block') {
                showHistory();
            }
        }
        
        // æ˜¾ç¤ºç®¡ç†å‘˜æ§åˆ¶é¢æ¿
        function showAdminControls() {
            adminControls.classList.add('show');
            adminBtn.textContent = 'ç®¡ç†å‘˜å·²ç™»å½•';
        }
        
        // éšè—ç®¡ç†å‘˜æ§åˆ¶é¢æ¿
        function hideAdminControls() {
            adminControls.classList.remove('show');
        }
        
        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        function showModal(modal) {
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        
        // éšè—æ¨¡æ€æ¡†
        function hideModal(modal) {
            modal.classList.remove('active');
            document.body.style.overflow = 'auto';
        }
        
        // æ˜¾ç¤ºæ¶ˆæ¯æç¤º
        function showMessage(message, type = 'info') {
            // å¦‚æœå·²å­˜åœ¨æ¶ˆæ¯ï¼Œå…ˆç§»é™¤
            const existingAlert = document.querySelector('.message-alert');
            if (existingAlert) {
                existingAlert.remove();
            }
            
            const alert = document.createElement('div');
            alert.textContent = message;
            alert.className = 'message-alert';
            alert.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 24px;
                background: ${type === 'success' ? '#27ae60' : type === 'error' ? '#e74c3c' : '#3498db'};
                color: white;
                border-radius: 5px;
                z-index: 9999;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                font-weight: 500;
                animation: slideIn 0.3s ease;
            `;
            
            document.body.appendChild(alert);
            
            setTimeout(() => {
                alert.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => alert.remove(), 300);
            }, 3000);
        }
        
        // æ·»åŠ åŠ¨ç”»æ ·å¼
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
