<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>家庭成员状态管理系统</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 25px 0;
            text-align: center;
            border-radius: 0 0 15px 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }
        
        h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 1rem;
            opacity: 0.9;
            margin-bottom: 10px;
        }
        
        .announcement-bar {
            background-color: #fff3cd;
            border-left: 5px solid #ffc107;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .members-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .member-card {
            background-color: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .member-header {
            padding: 18px;
            background-color: #2c3e50;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .member-name {
            font-size: 1.3rem;
            font-weight: 600;
        }
        
        .status-badge {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .status-safe {
            background-color: #2ecc71;
        }
        
        .status-transfer {
            background-color: #f39c12;
        }
        
        .status-medical {
            background-color: #e74c3c;
        }
        
        .member-body {
            padding: 18px;
        }
        
        .status-form {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .status-select {
            padding: 10px;
            border-radius: 6px;
            border: 2px solid #ddd;
            font-size: 1rem;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary {
            background-color: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
        }
        
        .btn-secondary {
            background-color: #95a5a6;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #7f8c8d;
        }
        
        .admin-btn-container {
            text-align: center;
            margin: 30px 0;
        }
        
        .admin-btn {
            background-color: #2c3e50;
            color: white;
            padding: 12px 25px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            padding: 25px;
        }
        
        .form-group {
            margin-bottom: 18px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .form-input {
            width: 100%;
            padding: 10px;
            border-radius: 6px;
            border: 2px solid #ddd;
            font-size: 1rem;
        }
        
        .error-message {
            color: #e74c3c;
            font-size: 0.9rem;
            margin-top: 5px;
            display: none;
        }
        
        .success-message {
            color: #2ecc71;
            font-size: 0.9rem;
            margin-top: 5px;
            display: none;
        }
        
        .admin-panel {
            display: none;
        }
        
        .admin-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        
        .admin-section-title {
            font-size: 1.2rem;
            margin-bottom: 12px;
            color: #2c3e50;
        }
        
        .member-list {
            display: grid;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .member-item {
            background-color: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logs-container {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 12px;
            background-color: #f8f9fa;
            font-size: 0.9rem;
        }
        
        .log-item {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        
        footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
            color: #666;
            font-size: 0.9rem;
        }
        
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 6px;
            color: white;
            font-weight: 600;
            z-index: 999;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 10px;
            opacity: 0;
            transform: translateY(100px);
            transition: all 0.5s ease;
        }
        
        .notification.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .notification-success {
            background-color: #2ecc71;
        }
        
        .notification-error {
            background-color: #e74c3c;
        }
        
        .notification-info {
            background-color: #3498db;
        }
        
        @media (max-width: 768px) {
            .members-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            .modal-content {
                width: 95%;
            }
        }
        
        @media (max-width: 480px) {
            .members-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1><i class="fas fa-home"></i> 家庭成员状态管理系统</h1>
            <p class="subtitle">实时更新家庭成员安全状态，确保紧急情况下及时响应</p>
            <p class="subtitle" style="font-size: 0.9rem;">Worker: family-status.mgjack13.workers.dev</p>
        </div>
    </header>
    
    <div class="container">
        <div class="announcement-bar">
            <i class="fas fa-bullhorn"></i>
            <div id="announcementText">正在加载公告...</div>
        </div>
        
        <div id="membersContainer" class="members-grid">
            <!-- 家庭成员卡片将通过JavaScript动态生成 -->
        </div>
        
        <div class="admin-btn-container">
            <button id="adminBtn" class="btn admin-btn">
                <i class="fas fa-user-shield"></i> 管理员入口
            </button>
        </div>
    </div>
    
    <!-- 管理员登录模态框 -->
    <div id="adminLoginModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-user-shield"></i> 管理员登录
            </h2>
            <div id="loginSection">
                <div class="form-group">
                    <label class="form-label" for="adminPassword">管理员密码</label>
                    <input type="password" id="adminPassword" class="form-input" placeholder="请输入管理员密码">
                    <div class="error-message" id="loginError">密码错误，请重新输入</div>
                    <p style="font-size: 0.85rem; color: #666; margin-top: 5px;">默认密码: 820421</p>
                </div>
                <button id="loginBtn" class="btn btn-primary">
                    <i class="fas fa-sign-in-alt"></i> 登录
                </button>
            </div>
            
            <div id="adminPanel" class="admin-panel">
                <div class="admin-section">
                    <h3 class="admin-section-title"><i class="fas fa-key"></i> 修改密码</h3>
                    <div class="form-group">
                        <input type="password" id="oldPassword" class="form-input" placeholder="旧密码">
                    </div>
                    <div class="form-group">
                        <input type="password" id="newPassword" class="form-input" placeholder="新密码 (6-10位字母数字)">
                    </div>
                    <div class="form-group">
                        <input type="password" id="confirmPassword" class="form-input" placeholder="确认新密码">
                        <div class="error-message" id="passwordChangeError"></div>
                        <div class="success-message" id="passwordChangeSuccess"></div>
                    </div>
                    <button id="changePasswordBtn" class="btn btn-primary">
                        <i class="fas fa-sync-alt"></i> 修改密码
                    </button>
                </div>
                
                <div class="admin-section">
                    <h3 class="admin-section-title"><i class="fas fa-users"></i> 管理成员</h3>
                    <div id="membersList" class="member-list">
                        <!-- 成员列表 -->
                    </div>
                    <div class="form-group">
                        <input type="text" id="newMemberName" class="form-input" placeholder="新成员姓名">
                    </div>
                    <button id="addMemberBtn" class="btn btn-primary">
                        <i class="fas fa-user-plus"></i> 添加成员
                    </button>
                </div>
                
                <div class="admin-section">
                    <h3 class="admin-section-title"><i class="fas fa-bullhorn"></i> 系统公告</h3>
                    <div class="form-group">
                        <textarea id="announcementInput" class="form-input" rows="3" placeholder="输入新的系统公告"></textarea>
                    </div>
                    <button id="updateAnnouncementBtn" class="btn btn-primary">
                        <i class="fas fa-paper-plane"></i> 更新公告
                    </button>
                </div>
                
                <div class="admin-section">
                    <h3 class="admin-section-title"><i class="fas fa-history"></i> 系统日志</h3>
                    <div id="logsContainer" class="logs-container">
                        <!-- 日志内容 -->
                    </div>
                </div>
                
                <div class="admin-section">
                    <button id="resetSystemBtn" class="btn btn-secondary">
                        <i class="fas fa-redo"></i> 重置系统数据
                    </button>
                    <button id="logoutBtn" class="btn btn-secondary" style="margin-top: 10px;">
                        <i class="fas fa-sign-out-alt"></i> 退出管理员
                    </button>
                </div>
            </div>
            
            <button id="closeModalBtn" class="btn btn-secondary" style="width: 100%; margin-top: 15px;">
                <i class="fas fa-times"></i> 关闭
            </button>
        </div>
    </div>
    
    <footer>
        <div class="container">
            <p>© 2023 家庭成员状态管理系统 | 用于紧急情况下的家庭成员状态跟踪</p>
            <p>Worker API: <code>https://family-status.mgjack13.workers.dev/</code></p>
        </div>
    </footer>
    
    <!-- 通知组件 -->
    <div id="notification" class="notification">
        <i class="fas fa-check-circle"></i>
        <span id="notificationText">操作成功</span>
    </div>
    
    <script>
        // 系统配置
        const CONFIG = {
            WORKER_URL: 'https://family-status.mgjack13.workers.dev/',
            DEFAULT_STATUSES: ['安全', '须转移', '须医疗帮助'],
            DEFAULT_PASSWORD: '820421'
        };
        
        // 状态常量
        const Status = {
            SAFE: '安全',
            TRANSFER: '须转移',
            MEDICAL: '须医疗帮助'
        };
        
        // 应用程序状态
        const AppState = {
            members: [],
            announcement: '',
            logs: [],
            isAdmin: false,
            adminToken: null
        };
        
        // DOM元素
        const domElements = {
            membersContainer: document.getElementById('membersContainer'),
            announcementText: document.getElementById('announcementText'),
            adminBtn: document.getElementById('adminBtn'),
            adminLoginModal: document.getElementById('adminLoginModal'),
            loginSection: document.getElementById('loginSection'),
            adminPanel: document.getElementById('adminPanel'),
            adminPassword: document.getElementById('adminPassword'),
            loginBtn: document.getElementById('loginBtn'),
            loginError: document.getElementById('loginError'),
            changePasswordBtn: document.getElementById('changePasswordBtn'),
            oldPassword: document.getElementById('oldPassword'),
            newPassword: document.getElementById('newPassword'),
            confirmPassword: document.getElementById('confirmPassword'),
            passwordChangeError: document.getElementById('passwordChangeError'),
            passwordChangeSuccess: document.getElementById('passwordChangeSuccess'),
            membersList: document.getElementById('membersList'),
            newMemberName: document.getElementById('newMemberName'),
            addMemberBtn: document.getElementById('addMemberBtn'),
            announcementInput: document.getElementById('announcementInput'),
            updateAnnouncementBtn: document.getElementById('updateAnnouncementBtn'),
            logsContainer: document.getElementById('logsContainer'),
            resetSystemBtn: document.getElementById('resetSystemBtn'),
            logoutBtn: document.getElementById('logoutBtn'),
            closeModalBtn: document.getElementById('closeModalBtn'),
            notification: document.getElementById('notification'),
            notificationText: document.getElementById('notificationText')
        };
        
        // 初始化应用程序
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
            setupEventListeners();
        });
        
        // 初始化应用程序数据
        async function initApp() {
            showNotification('正在加载数据...', 'info');
            
            try {
                // 加载公告
                await loadAnnouncement();
                
                // 加载成员
                await loadMembers();
                
                // 检查是否已有管理员令牌
                const savedToken = localStorage.getItem('adminToken');
                if (savedToken) {
                    // 验证令牌
                    const isValid = await verifyAdminToken(savedToken);
                    if (isValid) {
                        AppState.adminToken = savedToken;
                        AppState.isAdmin = true;
                        showNotification('已自动登录管理员', 'info');
                    } else {
                        localStorage.removeItem('adminToken');
                    }
                }
                
                showNotification('系统准备就绪', 'success');
            } catch (error) {
                console.error('初始化失败:', error);
                showNotification('数据加载失败，请检查网络连接', 'error');
            }
        }
        
        // 设置事件监听器
        function setupEventListeners() {
            // 管理员按钮
            domElements.adminBtn.addEventListener('click', showAdminLoginModal);
            
            // 登录按钮
            domElements.loginBtn.addEventListener('click', handleAdminLogin);
            
            // 修改密码
            domElements.changePasswordBtn.addEventListener('click', handleChangePassword);
            
            // 添加成员
            domElements.addMemberBtn.addEventListener('click', handleAddMember);
            
            // 更新公告
            domElements.updateAnnouncementBtn.addEventListener('click', handleUpdateAnnouncement);
            
            // 重置系统
            domElements.resetSystemBtn.addEventListener('click', handleResetSystem);
            
            // 退出管理员
            domElements.logoutBtn.addEventListener('click', handleLogout);
            
            // 关闭模态框
            domElements.closeModalBtn.addEventListener('click', () => {
                domElements.adminLoginModal.style.display = 'none';
            });
            
            // 按Enter键登录
            domElements.adminPassword.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleAdminLogin();
                }
            });
        }
        
        // 加载公告
        async function loadAnnouncement() {
            try {
                const response = await fetch(`${CONFIG.WORKER_URL}/api/announcement`);
                const data = await response.json();
                
                if (data.success) {
                    AppState.announcement = data.announcement;
                    domElements.announcementText.textContent = data.announcement;
                }
            } catch (error) {
                domElements.announcementText.textContent = '系统公告：请定期更新家庭成员状态，确保信息准确。';
            }
        }
        
        // 加载成员
        async function loadMembers() {
            try {
                const response = await fetch(`${CONFIG.WORKER_URL}/api/members`);
                const data = await response.json();
                
                if (data.success) {
                    AppState.members = data.members;
                    renderMemberCards();
                } else {
                    throw new Error(data.error || '加载成员失败');
                }
            } catch (error) {
                console.error('加载成员失败:', error);
                // 显示错误但仍然渲染空列表
                renderMemberCards();
            }
        }
        
        // 渲染成员卡片
        function renderMemberCards() {
            domElements.membersContainer.innerHTML = '';
            
            AppState.members.forEach(member => {
                const card = createMemberCard(member);
                domElements.membersContainer.appendChild(card);
            });
        }
        
        // 创建成员卡片
        function createMemberCard(member) {
            const card = document.createElement('div');
            card.className = 'member-card';
            card.dataset.memberId = member.id;
            
            const statusClass = getStatusClass(member.status);
            
            card.innerHTML = `
                <div class="member-header">
                    <div class="member-name">${member.name}</div>
                    <div class="status-badge ${statusClass}">${member.status}</div>
                </div>
                <div class="member-body">
                    <div class="status-form">
                        <select class="status-select" data-member-id="${member.id}">
                            <option value="安全" ${member.status === '安全' ? 'selected' : ''}>安全</option>
                            <option value="须转移" ${member.status === '须转移' ? 'selected' : ''}>须转移</option>
                            <option value="须医疗帮助" ${member.status === '须医疗帮助' ? 'selected' : ''}>须医疗帮助</option>
                        </select>
                        <button class="btn btn-primary save-status-btn" data-member-id="${member.id}">
                            <i class="fas fa-save"></i> 保存状态
                        </button>
                        <div class="last-updated" style="margin-top: 10px; font-size: 0.85rem; color: #666; text-align: center;">
                            最后更新: ${formatDate(member.lastUpdated)}
                        </div>
                    </div>
                </div>
            `;
            
            // 保存状态按钮事件
            const saveBtn = card.querySelector('.save-status-btn');
            saveBtn.addEventListener('click', async function() {
                const memberId = this.dataset.memberId;
                const statusSelect = card.querySelector('.status-select');
                const newStatus = statusSelect.value;
                
                await updateMemberStatus(memberId, newStatus);
            });
            
            return card;
        }
        
        // 获取状态CSS类
        function getStatusClass(status) {
            switch(status) {
                case '安全': return 'status-safe';
                case '须转移': return 'status-transfer';
                case '须医疗帮助': return 'status-medical';
                default: return 'status-safe';
            }
        }
        
        // 更新成员状态
        async function updateMemberStatus(memberId, newStatus) {
            try {
                const response = await fetch(`${CONFIG.WORKER_URL}/api/status-update`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        memberId: memberId,
                        newStatus: newStatus
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('状态更新成功', 'success');
                    await loadMembers(); // 重新加载成员
                } else {
                    throw new Error(data.error || '更新失败');
                }
            } catch (error) {
                showNotification('状态更新失败: ' + error.message, 'error');
            }
        }
        
        // 显示管理员登录模态框
        function showAdminLoginModal() {
            domElements.adminLoginModal.style.display = 'flex';
            domElements.adminPassword.value = '';
            domElements.loginError.style.display = 'none';
            
            if (AppState.isAdmin) {
                showAdminPanel();
            } else {
                domElements.loginSection.style.display = 'block';
                domElements.adminPanel.style.display = 'none';
            }
        }
        
        // 处理管理员登录
        async function handleAdminLogin() {
            const password = domElements.adminPassword.value.trim();
            
            if (!password) {
                domElements.loginError.textContent = '请输入密码';
                domElements.loginError.style.display = 'block';
                return;
            }
            
            domElements.loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 验证中...';
            domElements.loginBtn.disabled = true;
            
            try {
                const response = await fetch(`${CONFIG.WORKER_URL}/api/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ password: password })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    AppState.isAdmin = true;
                    AppState.adminToken = data.token;
                    localStorage.setItem('adminToken', data.token);
                    
                    domElements.loginSection.style.display = 'none';
                    showAdminPanel();
                    showNotification('管理员登录成功', 'success');
                } else {
                    domElements.loginError.textContent = data.error || '登录失败';
                    domElements.loginError.style.display = 'block';
                }
            } catch (error) {
                domElements.loginError.textContent = '登录失败，请检查网络连接';
                domElements.loginError.style.display = 'block';
            } finally {
                domElements.loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> 登录';
                domElements.loginBtn.disabled = false;
            }
        }
        
        // 显示管理员面板
        async function showAdminPanel() {
            domElements.adminPanel.style.display = 'block';
            
            // 加载管理员数据
            await loadAdminMembers();
            await loadAdminLogs();
            
            // 设置公告输入框
            domElements.announcementInput.value = AppState.announcement;
            
            // 清除密码输入框
            domElements.oldPassword.value = '';
            domElements.newPassword.value = '';
            domElements.confirmPassword.value = '';
            domElements.passwordChangeError.style.display = 'none';
            domElements.passwordChangeSuccess.style.display = 'none';
        }
        
        // 加载管理员成员列表
        async function loadAdminMembers() {
            try {
                await loadMembers(); // 重新加载成员
                renderAdminMembersList();
            } catch (error) {
                console.error('加载管理员成员失败:', error);
            }
        }
        
        // 渲染管理员成员列表
        function renderAdminMembersList() {
            domElements.membersList.innerHTML = '';
            
            AppState.members.forEach(member => {
                const memberItem = document.createElement('div');
                memberItem.className = 'member-item';
                memberItem.innerHTML = `
                    <span>${member.name}</span>
                    <button class="btn btn-secondary delete-member-btn" data-member-id="${member.id}" style="padding: 5px 10px; font-size: 0.9rem;">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                
                // 删除按钮事件
                const deleteBtn = memberItem.querySelector('.delete-member-btn');
                deleteBtn.addEventListener('click', function() {
                    if (confirm(`确定要删除成员 "${member.name}" 吗？`)) {
                        deleteMember(member.id);
                    }
                });
                
                domElements.membersList.appendChild(memberItem);
            });
        }
        
        // 删除成员
        async function deleteMember(memberId) {
            try {
                const response = await fetch(`${CONFIG.WORKER_URL}/api/admin/delete-member?id=${memberId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${AppState.adminToken}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('成员删除成功', 'success');
                    await loadAdminMembers(); // 重新加载列表
                } else {
                    throw new Error(data.error || '删除失败');
                }
            } catch (error) {
                showNotification('删除失败: ' + error.message, 'error');
            }
        }
        
        // 处理添加成员
        async function handleAddMember() {
            const newMemberName = domElements.newMemberName.value.trim();
            
            if (!newMemberName) {
                showNotification('请输入成员姓名', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${CONFIG.WORKER_URL}/api/admin/add-member`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AppState.adminToken}`
                    },
                    body: JSON.stringify({ name: newMemberName })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('成员添加成功: ' + newMemberName, 'success');
                    domElements.newMemberName.value = '';
                    await loadAdminMembers(); // 重新加载列表
                } else {
                    throw new Error(data.error || '添加失败');
                }
            } catch (error) {
                showNotification('添加失败: ' + error.message, 'error');
            }
        }
        
        // 处理密码修改
        async function handleChangePassword() {
            const oldPassword = domElements.oldPassword.value.trim();
            const newPassword = domElements.newPassword.value.trim();
            const confirmPassword = domElements.confirmPassword.value.trim();
            
            // 验证
            if (!oldPassword || !newPassword || !confirmPassword) {
                domElements.passwordChangeError.textContent = '所有字段都必须填写';
                domElements.passwordChangeError.style.display = 'block';
                domElements.passwordChangeSuccess.style.display = 'none';
                return;
            }
            
            if (newPassword !== confirmPassword) {
                domElements.passwordChangeError.textContent = '两次输入的新密码不一致';
                domElements.passwordChangeError.style.display = 'block';
                domElements.passwordChangeSuccess.style.display = 'none';
                return;
            }
            
            // 密码格式验证
            const passwordRegex = /^[A-Za-z0-9]{6,10}$/;
            if (!passwordRegex.test(newPassword)) {
                domElements.passwordChangeError.textContent = '新密码格式不正确，应为6-10位字母数字';
                domElements.passwordChangeError.style.display = 'block';
                domElements.passwordChangeSuccess.style.display = 'none';
                return;
            }
            
            domElements.changePasswordBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 修改中...';
            domElements.changePasswordBtn.disabled = true;
            
            try {
                const response = await fetch(`${CONFIG.WORKER_URL}/api/admin/change-password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AppState.adminToken}`
                    },
                    body: JSON.stringify({
                        oldPassword: oldPassword,
                        newPassword: newPassword
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    domElements.passwordChangeError.style.display = 'none';
                    domElements.passwordChangeSuccess.textContent = '密码修改成功';
                    domElements.passwordChangeSuccess.style.display = 'block';
                    
                    // 更新本地令牌
                    AppState.adminToken = data.token;
                    localStorage.setItem('adminToken', data.token);
                    
                    // 清除输入框
                    domElements.oldPassword.value = '';
                    domElements.newPassword.value = '';
                    domElements.confirmPassword.value = '';
                    
                    showNotification('密码修改成功', 'success');
                } else {
                    domElements.passwordChangeError.textContent = data.error || '密码修改失败';
                    domElements.passwordChangeError.style.display = 'block';
                    domElements.passwordChangeSuccess.style.display = 'none';
                }
            } catch (error) {
                domElements.passwordChangeError.textContent = '密码修改失败，请稍后重试';
                domElements.passwordChangeError.style.display = 'block';
                domElements.passwordChangeSuccess.style.display = 'none';
            } finally {
                domElements.changePasswordBtn.innerHTML = '<i class="fas fa-sync-alt"></i> 修改密码';
                domElements.changePasswordBtn.disabled = false;
            }
        }
        
        // 处理更新公告
        async function handleUpdateAnnouncement() {
            const newAnnouncement = domElements.announcementInput.value.trim();
            
            if (!newAnnouncement) {
                showNotification('请输入公告内容', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${CONFIG.WORKER_URL}/api/admin/update-announcement`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AppState.adminToken}`
                    },
                    body: JSON.stringify({ announcement: newAnnouncement })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // 更新前端显示
                    AppState.announcement = newAnnouncement;
                    domElements.announcementText.textContent = newAnnouncement;
                    
                    showNotification('公告更新成功', 'success');
                } else {
                    throw new Error(data.error || '更新失败');
                }
            } catch (error) {
                showNotification('公告更新失败: ' + error.message, 'error');
            }
        }
        
        // 加载管理员日志
        async function loadAdminLogs() {
            try {
                const response = await fetch(`${CONFIG.WORKER_URL}/api/admin/logs`, {
                    headers: {
                        'Authorization': `Bearer ${AppState.adminToken}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    AppState.logs = data.logs || [];
                    renderLogs();
                }
            } catch (error) {
                console.error('加载日志失败:', error);
            }
        }
        
        // 渲染日志
        function renderLogs() {
            domElements.logsContainer.innerHTML = '';
            
            // 按时间倒序
            const sortedLogs = [...AppState.logs].sort((a, b) => 
                new Date(b.timestamp) - new Date(a.timestamp)
            );
            
            sortedLogs.forEach(log => {
                const logItem = document.createElement('div');
                logItem.className = 'log-item';
                
                const timeString = formatDate(log.timestamp, true);
                let logText = '';
                
                if (log.action === '状态更新') {
                    logText = `<strong>${log.memberName}</strong> 状态从 "${log.oldStatus}" 更新为 "${log.newStatus}"`;
                    if (log.notes) logText += ` (备注: ${log.notes})`;
                } else if (log.action === '添加成员') {
                    logText = `添加了新成员: <strong>${log.memberName}</strong>`;
                } else if (log.action === '删除成员') {
                    logText = `删除了成员: <strong>${log.memberName}</strong>`;
                } else if (log.action === '更新公告') {
                    logText = `更新了系统公告`;
                } else if (log.action === '系统重置') {
                    logText = `系统已重置为默认状态`;
                } else {
                    logText = log.details || log.action;
                }
                
                logItem.innerHTML = `
                    <div>${logText}</div>
                    <div style="font-size: 0.8rem; color: #666; margin-top: 5px;">
                        ${timeString} | IP: ${log.ip || 'unknown'}
                    </div>
                `;
                
                domElements.logsContainer.appendChild(logItem);
            });
        }
        
        // 处理重置系统
        async function handleResetSystem() {
            if (!confirm('确定要重置系统数据吗？这将删除所有自定义成员和日志，恢复为默认状态。')) {
                return;
            }
            
            try {
                const response = await fetch(`${CONFIG.WORKER_URL}/api/admin/reset`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${AppState.adminToken}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('系统重置成功', 'success');
                    
                    // 重新加载所有数据
                    await loadAnnouncement();
                    await loadMembers();
                    await loadAdminMembers();
                    await loadAdminLogs();
                } else {
                    throw new Error(data.error || '重置失败');
                }
            } catch (error) {
                showNotification('系统重置失败: ' + error.message, 'error');
            }
        }
        
        // 处理退出管理员
        function handleLogout() {
            AppState.isAdmin = false;
            AppState.adminToken = null;
            localStorage.removeItem('adminToken');
            
            domElements.adminLoginModal.style.display = 'none';
            showNotification('已退出管理员模式', 'success');
        }
        
        // 验证管理员令牌
        async function verifyAdminToken(token) {
            try {
                const response = await fetch(`${CONFIG.WORKER_URL}/api/verify-token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ token: token })
                });
                
                const data = await response.json();
                return data.valid === true;
            } catch (error) {
                return false;
            }
        }
        
        // 显示通知
        function showNotification(message, type = 'success') {
            const notification = domElements.notification;
            const notificationText = domElements.notificationText;
            
            notificationText.textContent = message;
            
            // 设置通知类型
            notification.className = 'notification';
            notification.classList.add(`notification-${type}`);
            
            // 显示通知
            notification.classList.add('show');
            
            // 3秒后隐藏通知
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // 格式化日期
        function formatDate(dateString, includeTime = false) {
            if (!dateString) return '未知';
            
            const date = new Date(dateString);
            
            if (includeTime) {
                return date.toLocaleString('zh-CN');
            } else {
                return date.toLocaleDateString('zh-CN');
            }
        }
    </script>
</body>
</html>
